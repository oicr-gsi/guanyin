dist: trusty

language: node_js
node_js:
  - "node"

services:
  - postgresql

addons:
  postgresql: '9.5'

env:
  global:
  - NODE_ENV=test    

install:
  - npm install # note: do not use `npm ci` as it will remove flyway
  - rm node_modules/.bin/flyway || true # don't error if the symlink doesn't exist
  - cd node_modules/.bin && ln -s ../flyway/lib/flyway-5.0.7/flyway flyway && cd -
  - ls -lh node_modules/.bin 
  - npm install -g snyk@1.117.1

before_script:
  - psql -c "create user test with password 'test' createdb;" -U postgres
  - psql -c "ALTER USER test WITH superuser;" -U postgres
  - psql -c 'create database test_report_db with owner = test;' -U postgres
  - npm run fw:test-migrate
  - mkdir logs
  
script:
    - snyk test
    - npm run test
    - npm run lint

cache:
  directories:
    - "node_modules" 
